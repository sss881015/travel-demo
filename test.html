<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠéš¨èº«åŒ… V2</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojMGI2NmMzO2JvcmRlci1yYWRpdXM6MjAlIj48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMzY4IDE5MkwxNDQgMTkyIDE0NCAxNDMgMTkyIDExMiAyMjEgMTEyIDIzNyA5NiAzMjAgOTYgMzM2IDExMiAzODQgMTEyIDM4NCAxNjAgMzY4IDE2MHpNMzY4IDE5Mkw0MTYgMjI0IDQxNiAzMzYgMzY4IDM2OCAxNDQgMzY4IDk2IDMzNiA5NiAyMjQgMTQ0IDE5MkwxNDQgMzY4IDM2OCAzNjh6Ii8+PC9zdmc+">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojMGI2NmMzO2JvcmRlci1yYWRpdXM6MjAlIj48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMzY4IDE5MkwxNDQgMTkyIDE0NCAxNDMgMTkyIDExMiAyMjEgMTEyIDIzNyA5NiAzMjAgOTYgMzM2IDExMiAzODQgMTEyIDM4NCAxNjAgMzY4IDE2MHpNMzY4IDE5Mkw0MTYgMjI0IDQxNiAzMzYgMzY4IDM2OCAxNDQgMzY4IDk2IDMzNiA5NiAyMjQgMTQ0IDE5MkwxNDQgMzY4IDM2OCAzNjh6Ii8+PC9zdmc+">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            -webkit-user-select: none; user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        input, select { -webkit-user-select: text; user-select: text; }
        
        /* Checkbox æ¨£å¼å„ªåŒ– */
        .checkbox-wrapper input:checked + div {
            background-color: #dbeafe; /* blue-100 */
            color: #2563eb; /* blue-600 */
            border-color: #2563eb;
        }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
    
    <header class="bg-blue-600 text-white p-4 pt-12 pb-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wide">âœˆï¸ æ—…éŠåˆ†å¸³ç‹</h1>
            <button @click="clearAllData" class="text-xs bg-blue-700 px-2 py-1 rounded text-blue-200">é‡ç½®</button>
        </div>
    </header>

    <main class="flex-1 p-4 pb-24 overflow-y-auto">
        
        <div v-if="currentTab === 'itinerary'" class="space-y-4">
            <div class="card p-4">
                <div class="flex gap-2">
                    <input v-model="newPlace" @keyup.enter="addPlace" type="text" placeholder="è¼¸å…¥åœ°é» (ä¾‹: æ·ºè‰å¯º)" class="flex-1 border-0 bg-gray-100 p-3 rounded-lg focus:ring-2 ring-blue-500 outline-none text-lg">
                    <button @click="addPlace" class="bg-blue-600 text-white w-12 rounded-lg text-2xl shadow active:scale-95 transition">+</button>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(place, index) in itinerary" :key="place.id" class="card p-4 flex justify-between items-center active:scale-[0.99] transition duration-100">
                    <div class="flex-1" @click="openMap(place.name)">
                        <div class="font-bold text-gray-800 text-lg">{{ place.name }}</div>
                        <div class="text-xs text-blue-500 flex items-center gap-1 mt-1">
                            ğŸ—ºï¸ é»æ“Šå°èˆª
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 border-l pl-3 ml-2">
                        <button @click.stop="movePlace(index, -1)" v-if="index > 0" class="text-gray-400 hover:text-blue-500">â–²</button>
                        <button @click.stop="movePlace(index, 1)" v-if="index < itinerary.length - 1" class="text-gray-400 hover:text-blue-500">â–¼</button>
                        <button @click.stop="removePlace(index)" class="text-red-400 text-xs mt-1">åˆªé™¤</button>
                    </div>
                </div>
                <div v-if="itinerary.length === 0" class="text-center text-gray-400 mt-10">
                    <div class="text-4xl mb-2">ğŸ—ºï¸</div>
                    <div>è¼¸å…¥åœ°é»é–‹å§‹è¦åŠƒè¡Œç¨‹</div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'money'" class="space-y-4">
            
            <div class="card p-4 bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-lg">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-300 text-sm">ç¸½æ”¯å‡º</span>
                    <span class="text-2xl font-bold">${{ totalExpense }}</span>
                </div>
                <div class="space-y-2 border-t border-gray-600 pt-3">
                    <div v-for="result in balanceSheet" :key="result.name" class="flex justify-between text-sm items-center">
                        <span class="text-gray-200">{{ result.name }}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400" v-if="result.balance !== 0">
                                {{ result.balance > 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜' }}
                            </span>
                            <span :class="result.balance >= 0 ? 'text-green-300' : 'text-red-300'" class="font-mono font-bold text-base">
                                ${{ Math.abs(result.balance).toFixed(0) }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 border border-blue-100">
                <h3 class="font-bold text-gray-700 mb-3 text-sm">âœï¸ æ–°å¢ä¸€ç­†</h3>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input v-model="newExpense.title" type="text" placeholder="é …ç›® (å¦‚: æ™šé¤)" class="col-span-2 bg-gray-50 p-3 rounded-lg border border-gray-200 outline-none focus:border-blue-500">
                    <input v-model.number="newExpense.amount" type="number" placeholder="$" class="bg-gray-50 p-3 rounded-lg border border-gray-200 outline-none focus:border-blue-500">
                </div>
                
                <div class="mb-3">
                    <label class="text-xs text-gray-500 block mb-1">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label>
                    <select v-model="newExpense.payer" class="w-full bg-gray-50 p-3 rounded-lg border border-gray-200 outline-none">
                        <option v-for="p in people" :value="p">{{ p }}</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="text-xs text-gray-500 block mb-1">èª°è¦åˆ†æ”¤ï¼Ÿ (é è¨­å…¨é¸)</label>
                    <div class="flex flex-wrap gap-2">
                        <label v-for="p in people" :key="p" class="checkbox-wrapper cursor-pointer relative">
                            <input type="checkbox" :value="p" v-model="newExpense.involved" class="absolute opacity-0 w-0 h-0">
                            <div class="px-3 py-1 rounded-full border border-gray-200 text-sm text-gray-500 bg-white transition select-none">
                                {{ p }}
                            </div>
                        </label>
                    </div>
                    <div v-if="newExpense.involved.length === 0" class="text-red-500 text-xs mt-1">âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€äººåˆ†æ”¤</div>
                </div>

                <button @click="addExpense" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow active:scale-95 transition disabled:opacity-50 disabled:scale-100" :disabled="!isValidExpense">
                    è¨˜å¸³
                </button>
            </div>

            <div class="space-y-2 pb-10">
                <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">{{ exp.title }}</div>
                        <div class="text-xs text-gray-500">
                            <span class="font-bold text-blue-600">{{ exp.payer }}</span> å…ˆä»˜
                            <span class="text-gray-400 mx-1">|</span>
                            åˆ†æ”¤: {{ formatInvolved(exp.involved) }}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-gray-800 text-lg">${{ exp.amount }}</span>
                        <button @click="removeExpense(index)" class="text-gray-300 hover:text-red-500 px-2 text-xl">Ã—</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'settings'" class="card p-4">
            <h3 class="font-bold mb-4 text-gray-700">ğŸ‘¥ æˆå“¡è¨­å®š</h3>
            <div class="flex gap-2 mb-6">
                <input v-model="newPerson" @keyup.enter="addPerson" type="text" placeholder="åå­—" class="flex-1 bg-gray-100 p-2 rounded">
                <button @click="addPerson" class="bg-gray-800 text-white px-4 rounded">æ–°å¢</button>
            </div>
            <div class="space-y-2">
                <div v-for="(p, index) in people" :key="p" class="flex justify-between items-center p-3 bg-gray-50 rounded border border-gray-100">
                    <span class="font-medium">{{ p }}</span>
                    <button @click="removePerson(index)" class="text-red-400 text-sm" v-if="people.length > 1">ç§»é™¤</button>
                </div>
            </div>
            <div class="mt-8 text-center text-xs text-gray-400">
                App Version 2.0 (åˆ†å¸³å¢å¼·ç‰ˆ)
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around pb-safe pt-2 pb-2 z-50">
        <button @click="currentTab = 'itinerary'" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'itinerary' ? 'text-blue-600' : 'text-gray-400'">
            <span class="text-xl">ğŸ“</span><span class="text-xs mt-1">è¡Œç¨‹</span>
        </button>
        <button @click="currentTab = 'money'" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'money' ? 'text-green-600' : 'text-gray-400'">
            <span class="text-xl">ğŸ’°</span><span class="text-xs mt-1">åˆ†å¸³</span>
        </button>
        <button @click="currentTab = 'settings'" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'settings' ? 'text-gray-600' : 'text-gray-400'">
            <span class="text-xl">âš™ï¸</span><span class="text-xs mt-1">è¨­å®š</span>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            
            // åˆå§‹åŒ–è³‡æ–™ (é è¨­å…©å€‹äºº)
            const people = ref(JSON.parse(localStorage.getItem('travel_people')) || ['æˆ‘', 'æ—…ä¼´']);
            const itinerary = ref(JSON.parse(localStorage.getItem('travel_itinerary')) || []);
            const expenses = ref(JSON.parse(localStorage.getItem('travel_expenses')) || []);

            // è¼¸å…¥æš«å­˜
            const newPlace = ref('');
            const newPerson = ref('');
            // newExpense å¤šäº†ä¸€å€‹ involved (é™£åˆ—)
            const newExpense = ref({ 
                title: '', 
                amount: '', 
                payer: people.value[0], 
                involved: [...people.value] // é è¨­å…¨é¸
            });

            // è‡ªå‹•å­˜æª”
            watch(people, (val) => localStorage.setItem('travel_people', JSON.stringify(val)), { deep: true });
            watch(itinerary, (val) => localStorage.setItem('travel_itinerary', JSON.stringify(val)), { deep: true });
            watch(expenses, (val) => localStorage.setItem('travel_expenses', JSON.stringify(val)), { deep: true });

            // ç•¶æˆå“¡åå–®æ”¹è®Šæ™‚ï¼ŒåŒæ­¥æ›´æ–° newExpense çš„é è¨­å€¼
            watch(people, (newPeople) => {
                // å¦‚æœç›®å‰è¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå°±è‡ªå‹•å¹«å¿™å…¨é¸æ–°åå–®ï¼Œæ–¹ä¾¿ä½¿ç”¨
                if (!newExpense.value.title && !newExpense.value.amount) {
                    newExpense.value.involved = [...newPeople];
                    if (!newPeople.includes(newExpense.value.payer)) {
                        newExpense.value.payer = newPeople[0];
                    }
                }
            }, { deep: true });

            // --- åœ°åœ–èˆ‡è¡Œç¨‹ ---
            const openMap = (name) => {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;
                window.open(url, '_blank');
            };
            const addPlace = () => {
                if (!newPlace.value.trim()) return;
                itinerary.value.push({ id: Date.now(), name: newPlace.value });
                newPlace.value = '';
            };
            const removePlace = (index) => itinerary.value.splice(index, 1);
            const movePlace = (index, dir) => {
                const temp = itinerary.value[index];
                itinerary.value[index] = itinerary.value[index + dir];
                itinerary.value[index + dir] = temp;
            };

            // --- è¨˜å¸³é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹è™•) ---
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥æ–°å¢ (æœ‰æ¨™é¡Œã€æœ‰é‡‘é¡ã€è‡³å°‘é¸äº†ä¸€äººåˆ†æ”¤)
            const isValidExpense = computed(() => {
                return newExpense.value.title && 
                       newExpense.value.amount && 
                       newExpense.value.involved.length > 0;
            });

            const addExpense = () => {
                if (!isValidExpense.value) return;
                
                // ç‚ºäº†é¿å…å‚³åƒç…§ï¼Œé€™è£¡ç”¨å±•é–‹é‹ç®—å­è¤‡è£½ä¸€ä»½
                expenses.value.unshift({ 
                    title: newExpense.value.title,
                    amount: newExpense.value.amount,
                    payer: newExpense.value.payer,
                    involved: [...newExpense.value.involved] 
                });
                
                // é‡ç½®è¼¸å…¥æ¡†ï¼Œé è¨­å†æ¬¡å…¨é¸æ‰€æœ‰äºº
                newExpense.value = { 
                    title: '', 
                    amount: '', 
                    payer: people.value[0], 
                    involved: [...people.value] 
                };
            };

            const removeExpense = (index) => expenses.value.splice(index, 1);

            // æ ¼å¼åŒ–é¡¯ç¤ºåˆ†æ”¤åå–® (å¦‚æœå…¨é¸å°±é¡¯ç¤º"å…¨å“¡"ï¼Œä¸ç„¶é¡¯ç¤ºäººå)
            const formatInvolved = (involvedList) => {
                if (!involvedList) return 'å…¨å“¡'; // ç›¸å®¹èˆŠè³‡æ–™
                if (involvedList.length === people.value.length) return 'å…¨å“¡';
                return involvedList.join(', ');
            };

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));

            // *** çµç®—é‚è¼¯æ”¹å¯« ***
            const balanceSheet = computed(() => {
                if (people.value.length === 0) return [];
                
                // åˆå§‹åŒ–æ¯å€‹äººçš„å¸³æˆ¶é¤˜é¡ç‚º 0
                let balances = {};
                people.value.forEach(p => balances[p] = 0);

                expenses.value.forEach(exp => {
                    const amount = Number(exp.amount) || 0;
                    const payer = exp.payer;
                    // å¦‚æœæ˜¯èˆŠè³‡æ–™æ²’æœ‰ involved æ¬„ä½ï¼Œé è¨­ç‚ºæ‰€æœ‰äºº
                    const involved = (exp.involved && exp.involved.length > 0) ? exp.involved : people.value;

                    // 1. ä»˜æ¬¾äººï¼šå¸³æˆ¶å¢åŠ  (å› ç‚ºä»–å…ˆå¢Šäº†éŒ¢ï¼Œå¤§å®¶æ¬ ä»–)
                    if (balances[payer] !== undefined) {
                        balances[payer] += amount;
                    }

                    // 2. åˆ†æ”¤äººï¼šå¸³æˆ¶æ‰£æ¬¾ (æ¯å€‹äººæ‡‰ä»˜çš„éŒ¢)
                    const splitAmount = amount / involved.length;
                    involved.forEach(person => {
                        if (balances[person] !== undefined) {
                            balances[person] -= splitAmount;
                        }
                    });
                });

                // è½‰æˆé™£åˆ—æ ¼å¼æ–¹ä¾¿é¡¯ç¤º
                return people.value.map(p => ({
                    name: p,
                    balance: balances[p]
                }));
            });

            // --- æˆå“¡ç®¡ç† ---
            const addPerson = () => {
                if (!newPerson.value.trim()) return;
                people.value.push(newPerson.value);
                // æ–°å¢äººæ™‚ï¼Œè‡ªå‹•åŠ é€²ç•¶å‰è¼¸å…¥çš„é è¨­åˆ†æ”¤åå–®
                newExpense.value.involved.push(newPerson.value);
                newPerson.value = '';
            };
            const removePerson = (index) => {
                if(confirm('åˆªé™¤æˆå“¡å¯èƒ½æœƒå½±éŸ¿è¨˜å¸³ç´€éŒ„')) people.value.splice(index, 1);
            };
            const clearAllData = () => {
                if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿè³‡æ–™å°‡æ¶ˆå¤±')) {
                    itinerary.value = []; expenses.value = []; people.value = ['æˆ‘', 'æ—…ä¼´'];
                    localStorage.clear();
                    // é‡ç½®é é¢ç‹€æ…‹
                    newExpense.value.involved = [...people.value];
                }
            };

            return {
                currentTab, people, itinerary, expenses, 
                newPlace, newPerson, newExpense, isValidExpense,
                addPlace, removePlace, movePlace, openMap,
                addExpense, removeExpense, addPerson, removePerson, clearAllData,
                totalExpense, balanceSheet, formatInvolved
            };
        }
    }).mount('#app');
</script>
</body>
</html>